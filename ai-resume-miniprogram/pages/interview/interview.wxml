<!-- interview.wxml -->
<view class="container">
  
  <!-- 简历选择弹窗 -->
  <view class="modal-overlay" wx:if="{{showResumeSelectModal}}" bindtap="">
    <view class="resume-select-modal" catchtap="">
      <view class="modal-header">
        <view class="modal-title">选择面试简历</view>
      </view>
      <view class="modal-content">
        <view class="resume-list">
          <view 
            wx:for="{{resumeList}}" 
            wx:key="id" 
            class="resume-item {{selectedResumeId === item.id ? 'selected' : ''}}" 
            bindtap="selectResume" 
            data-id="{{item.id}}"
          >
            <view class="resume-info">
              <view class="resume-title">{{item.title}}</view>
              <view class="resume-occupation">{{item.occupation}}</view>
              <view class="resume-time">更新时间: {{item.updateTime}}</view>
            </view>
            <view class="resume-select-icon" wx:if="{{selectedResumeId === item.id}}">
              <image src="/images/check.png" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <text class="tips">请选择一份简历，AI将基于简历内容生成面试问题</text>
      </view>
    </view>
  </view>
  <!-- 顶部导航栏 -->
  <view class="header">
    <view class="header-left" bindtap="goBack">
      <image src="/images/avatar.png" mode="aspectFit" class="avatar-icon"></image>
      <view class="job-badge">{{industryJobTag || '技术面试'}}</view>
    </view>
    <view class="header-center">AI 模拟面试</view>
    <view class="header-right">
      <view class="progress-area">
        <view class="countdown-timer {{sessionTimeRemaining < 60 ? 'time-warning pulse' : ''}}">
          {{formatRemainingTime(sessionTimeRemaining)}}
        </view>
        <view class="progress-bar">
          <view 
            class="progress-fill"
            style="width: {{(sessionTimeRemaining / data.sessionSeconds) * 100}}%"
          ></view>
        </view>
      </view>
    </view>
  </view>

  <!-- 面试官风格选择模块 - personaSelector -->
  <view class="persona-selector" wx:if="{{false}}">
    <view class="selector-title">选择面试官风格</view>
    
    <!-- 水平卡片布局 -->
    <view class="persona-cards">
      <view 
        wx:for="{{personas}}" 
        wx:key="id" 
        class="persona-card persona-{{item.id}} {{persona === item.id ? 'selected' : ''}}"
        bindtap="selectPersona"
        data-id="{{item.id}}"
      >
        <view class="persona-emoji">{{item.emoji}}</view>
        <view class="persona-name">{{item.name}}</view>
      </view>
    </view>
    
    <!-- 预览区域 -->
    <view class="preview-section" wx:if="{{previewQuestion}}">
      <view class="preview-question">{{previewQuestion}}</view>
    </view>
    
    <!-- 开始面试按钮 -->
    <button 
      class="start-interview-btn {{personaSelected ? 'active' : 'disabled'}}"
      bindtap="startInterview"
      disabled="{{!personaSelected}}"
    >
      开始面试
    </button>
  </view>

  <!-- 主内容区域 -->
  <view class="main-content">
    <!-- 左侧：AI问题卡片 -->
    <view class="left-column">
      <view class="question-card-wrapper" wx:if="{{!showFeedback}}">
        <view class="question-card {{animationState.questionCard !== 'idle' ? 'fade-in-bottom' : ''}}">
          <view class="question-header">
            <view class="persona-label persona-{{persona}}">
              {{getPersonaText(persona)}}
            </view>
          </view>
          <view class="question-content">{{currentQuestion.content}}</view>
          <view class="hint-text" wx:if="{{currentQuestion.expectedKeyPoints && currentQuestion.expectedKeyPoints.length > 0}}">
            提示: 请重点回答 {{currentQuestion.expectedKeyPoints.join('、')}}
          </view>
        </view>
      </view>

      <!-- 历史记录面板 -->
      <view class="history-panel" wx:if="{{interviewHistory && interviewHistory.length > 0}}">
        <view class="history-header" bindtap="toggleHistory">
          <view class="history-title">历史问答</view>
          <view class="history-count">{{interviewHistory.length}} 条</view>
          <view class="history-toggle">{{historyExpanded ? '收起' : '展开'}}</view>
        </view>
        <view class="history-content" wx:if="{{historyExpanded || interviewHistory.length <= 2}}">
          <view wx:for="{{interviewHistory}}" wx:key="index" class="history-item">
            <view class="history-question">{{item.question}}</view>
            <view class="history-answer">{{item.answer.substring(0, 30)}}...</view>
            <view class="history-score">评分: {{item.score}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 右侧：用户回答面板和AI反馈卡片 -->
    <view class="right-column">
      <!-- 答题面板 - AnswerPanel -->
      <view class="user-answer-panel">
        <view class="panel-header">
          <view class="panel-title">请回答</view>
          <view class="recording-status" wx:if="{{recording}}">正在录音...</view>
        </view>
        
        <!-- 录音按钮 -->
        <view class="record-button-container">
          <button 
            class="record-button {{recording ? 'recording' : ''}}"
            bindtouchstart="startRecord"
            bindtouchend="stopRecord"
          >
            <image src="/images/mic_white.png" class="mic-icon"></image>
          </button>
          <view class="record-hint">长按录音</view>
        </view>

        <!-- 转写文本框 -->
        <view class="transcription-box">
          <textarea 
            class="transcription-textarea" 
            placeholder="回答内容将显示在这里..."
            value="{{userAnswer}}"
            bindinput="onAnswerInput"
            auto-height
            maxlength="1000"
          ></textarea>
        </view>

        <!-- 提交行 -->
        <view class="submit-row">
          <button 
            class="submit-btn-secondary"
            bindtap="resetRecording"
            disabled="{{!userAnswer}}"
          >
            重录
          </button>
          <button 
            class="submit-btn-primary"
            bindtap="submitAnswer"
            disabled="{{!userAnswer.trim()}}"
          >
            提交回答
          </button>
          <button 
            class="submit-btn-secondary"
            bindtap="addNote"
          >
            补充说明
          </button>
        </view>
      </view>

      <!-- 评分反馈区域 - PerQuestionFeedback -->
      <view class="ai-feedback-card {{animationState.feedbackPanel !== 'idle' ? 'fade-in' : ''}}" wx:if="showFeedback">
        <view class="feedback-header">
          <view class="feedback-title">AI评分反馈</view>
          <view class="overall-score">{{calculateOverallScore()}}</view>
        </view>
        
        <view class="score-donut">
          <view class="score-item">
            <view class="score-circle tech">{{questionScore.tech}}</view>
            <view class="score-label">技术</view>
          </view>
          <view class="score-item">
            <view class="score-circle logic">{{questionScore.logic}}</view>
            <view class="score-label">逻辑</view>
          </view>
          <view class="score-item">
            <view class="score-circle clarity">{{questionScore.clarity}}</view>
            <view class="score-label">表达</view>
          </view>
          <view class="score-item">
            <view class="score-circle depth">{{questionScore.depth}}</view>
            <view class="score-label">深度</view>
          </view>
        </view>
        
        <view class="matched-points-tags">
          <view 
            wx:for="{{matchedPoints}}" 
            wx:key="index" 
            class="matched-point-tag"
          >
            ✓ {{item}}
          </view>
        </view>
        
        <view class="quick-tips">
          {{feedbackText}}
        </view>
        
        <!-- 城市薪资匹配结果 -->
        <view class="salary-match-card" wx:if="salaryMatchResult && salaryMatchResult.industryAverage">
          <view class="salary-title">
            <image src="/images/settings.png" class="salary-icon"></image>
            薪资匹配分析
          </view>
          <view class="salary-content">
            <view class="salary-item">
              <view class="salary-label">行业平均</view>
              <view class="salary-value">{{salaryMatchResult.industryAverage}}</view>
            </view>
            <view class="salary-item">
              <view class="salary-label">您的水平</view>
              <view class="salary-value salary-match">
                {{salaryMatchResult.matchPercentage}}% <text class="match-status">{{salaryMatchResult.matchStatus}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部控制按钮 -->
  <view class="footer-controls">
    <button 
      class="footer-btn footer-btn-secondary"
      bindtap="skipQuestion"
      disabled="{{!userAnswer}}"
    >
      跳过
    </button>
    <button 
      class="footer-btn footer-btn-warning"
      bindtap="togglePause"
    >
      {{isPaused ? '继续' : '暂停'}}
    </button>
    <button 
      class="footer-btn footer-btn-primary"
      bindtap="finishInterview"
    >
      结束并生成报告
    </button>
  </view>

  <!-- 时间警告覆盖层 -->
  <view class="time-warning-overlay" wx:if="{{sessionTimeRemaining < 60}}">
    <view class="warning-content">
      <view class="warning-icon">⚠️</view>
      <view class="warning-text">面试即将结束</view>
      <view class="warning-time">{{formatRemainingTime(sessionTimeRemaining)}}</view>
    </view>
  </view>
</view>