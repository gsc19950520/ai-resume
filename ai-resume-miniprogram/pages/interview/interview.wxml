<!-- interview.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="header">
    <view class="header-left" bindtap="goBack">
      <image src="/images/arrow.png" mode="aspectFit" class="back-icon"></image>
    </view>
    <view class="header-title">AIæ¨¡æ‹Ÿé¢è¯•</view>
    <view class="header-right"></view>
  </view>

  <!-- è¡Œä¸š-å²—ä½æ ‡ç­¾ -->
  <view class="industry-job-tag" wx:if="industryJobTag">
    {{industryJobTag}}
  </view>

  <!-- é¢è¯•å®˜é£æ ¼é€‰æ‹©æ¨¡å— - personaSelector -->
  <view class="persona-selector" wx:if="{{!currentQuestion.content && !loading}}">
    <view class="selector-title">é€‰æ‹©é¢è¯•å®˜é£æ ¼</view>
    
    <!-- å¡ç‰‡ç½‘æ ¼å¸ƒå±€ -->
    <view class="persona-grid">
      <view 
        wx:for="{{personas}}" 
        wx:key="id" 
        class="persona-card {{persona === item.id ? 'selected' : ''}}"
        bindtap="selectPersona"
        data-id="{{item.id}}"
      >
        <view class="persona-emoji">{{item.emoji}}</view>
        <view class="persona-name">{{item.name}}</view>
        <view class="persona-description">{{item.description}}</view>
        <view class="persona-example">{{item.example}}</view>
      </view>
    </view>
    
    <!-- é¢„è§ˆåŒºåŸŸ -->
    <view class="preview-section" wx:if="{{previewQuestion}}">
      <view class="preview-title">é¢„è§ˆ</view>
      <view class="preview-question">{{previewQuestion}}</view>
    </view>
    
    <!-- å¼€å§‹é¢è¯•æŒ‰é’® -->
    <button 
      class="start-interview-btn {{personaSelected ? 'active' : 'disabled'}}"
      bindtap="startInterview"
      disabled="{{!personaSelected}}"
    >
      å¼€å§‹é¢è¯•
    </button>
  </view>

  <!-- ä¼šè¯ä¿¡æ¯ -->
  <view class="interview-header">
    <view class="interview-info">
      <text class="position">{{industryJobTag || 'æŠ€æœ¯é¢è¯•'}}</text>
      <text class="persona" wx:if="{{persona}}">
        é¢è¯•å®˜é£æ ¼: {{getPersonaText(persona)}}
      </text>
    </view>
    <view class="timer {{sessionTimeRemaining < 180 ? 'warning' : ''}}" wx:if="{{!showFeedback}}">
      <image src="/images/settings.png" mode="aspectFit" class="timer-icon"></image>
      å‰©ä½™æ—¶é—´: {{formatRemainingTime(sessionTimeRemaining)}}
    </view>
    <view class="answer-duration" wx:if="{{showFeedback}}">
      <image src="/images/settings.png" mode="aspectFit" class="timer-icon"></image>
      å›ç­”æ—¶é•¿: {{formatAnswerDuration(answerDuration)}}
    </view>
  </view>

  <!-- é—®é¢˜å¡ç‰‡ - QuestionCard -->
  <view class="question-card-wrapper" wx:if="{{!showFeedback}}">
    <view class="question-card gradient-border {{animationState.questionCard !== 'idle' ? 'animate-in' : ''}}">
      <view class="question-header">
        <text class="question-round">ç¬¬{{currentRound}}è½®</text>
        <text class="question-depth" wx:if="{{currentQuestion.depthLevel}}">
          {{getDepthDescription(currentQuestion.depthLevel)}}
        </text>
      </view>
      <view class="question-content">{{currentQuestion.content}}</view>
      <view class="expected-points" wx:if="{{currentQuestion.expectedKeyPoints && currentQuestion.expectedKeyPoints.length > 0}}">
        <text class="points-title">è€ƒæ ¸è¦ç‚¹ï¼š</text>
        <view class="points-list">
          <view class="point-item" wx:for="{{currentQuestion.expectedKeyPoints}}" wx:key="index">
            {{item}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­”é¢˜é¢æ¿ - AnswerPanel -->
  <view class="answer-panel">
    <view class="panel-title">è¯·å›ç­”</view>
    <view class="answer-textarea-container">
      <textarea 
        class="answer-textarea" 
        placeholder="è¯·è¾“å…¥æ‚¨çš„å›ç­”..."
        value="{{userAnswer}}"
        bindinput="onAnswerInput"
        auto-height
        maxlength="1000"
      ></textarea>
      <view class="word-count">{{userAnswer.length}}/1000</view>
    </view>

    <!-- éŸ³é¢‘æ§åˆ¶ -->
    <view class="audio-controls">
      <button 
        class="audio-btn record-btn {{recording ? 'recording' : ''}}" 
        bindtap="toggleRecording"
        loading="{{recording}}"
      >
        <image src="/images/settings.png" class="btn-icon"></image>
        {{recording ? 'åœæ­¢å½•éŸ³' : 'å¼€å§‹å½•éŸ³'}}
      </button>
      <button 
        class="audio-btn play-btn"
        bindtap="playRecording"
        disabled="{{!recordingUrl}}">
        <image src="/images/settings.png" class="btn-icon"></image>
        æ’­æ”¾å½•éŸ³
      </button>
      <button 
        class="audio-btn transcribe-btn"
        bindtap="transcribeAudio"
        disabled="{{!recordingUrl || transcribing}}">
        <image src="/images/settings.png" class="btn-icon"></image>
        {{transcribing ? 'è½¬å†™ä¸­...' : 'å½•éŸ³è½¬æ–‡å­—'}}
      </button>
    </view>
  </view>

  <!-- è¯„åˆ†åé¦ˆåŒºåŸŸ - PerQuestionFeedback -->
  <view class="feedback-section {{animationState.feedbackPanel !== 'idle' ? 'animate-in' : ''}}" wx:if="showFeedback">
    <view class="feedback-title">è¯„åˆ†åé¦ˆ</view>
    <view class="score-section">
      <view class="score-item">
        <view class="score-header">
          <view class="score-label">æŠ€æœ¯æ·±åº¦</view>
          <view class="score-value score-{{getScoreLevel(questionScore.tech)}}">{{questionScore.tech}}/10</view>
        </view>
        <view class="score-bar">
          <view class="score-fill tech" style="width: {{questionScore.tech * 10}}%"></view>
        </view>
      </view>
      <view class="score-item">
        <view class="score-header">
          <view class="score-label">é€»è¾‘è¡¨è¾¾</view>
          <view class="score-value score-{{getScoreLevel(questionScore.logic)}}">{{questionScore.logic}}/10</view>
        </view>
        <view class="score-bar">
          <view class="score-fill logic" style="width: {{questionScore.logic * 10}}%"></view>
        </view>
      </view>
      <view class="score-item">
        <view class="score-header">
          <view class="score-label">è¡¨è¾¾æ¸…æ™°åº¦</view>
          <view class="score-value score-{{getScoreLevel(questionScore.clarity)}}">{{questionScore.clarity}}/10</view>
        </view>
        <view class="score-bar">
          <view class="score-fill clarity" style="width: {{questionScore.clarity * 10}}%"></view>
        </view>
      </view>
      <view class="score-item">
        <view class="score-header">
          <view class="score-label">å›ç­”æ·±åº¦</view>
          <view class="score-value score-{{getScoreLevel(questionScore.depth)}}">{{questionScore.depth}}/10</view>
        </view>
        <view class="score-bar">
          <view class="score-fill depth" style="width: {{questionScore.depth * 10}}%"></view>
        </view>
      </view>
    </view>
    <view class="feedback-content">{{feedbackText}}</view>
    <view class="matched-points" wx:if="matchedPoints && matchedPoints.length > 0">
      <view class="matched-title">è¦†ç›–è¦ç‚¹ï¼š</view>
      <view wx:for="{{matchedPoints}}" wx:key="index" class="matched-item">âœ“ {{item}}</view>
    </view>
    <view class="consecutive-no-match" wx:if="{{consecutiveNoMatchCount >= 2}}">
      <text class="no-match-warning">âš ï¸ è¯·æ³¨æ„å›ç­”è´¨é‡ï¼Œå·²è¿ç»­{{consecutiveNoMatchCount}}è½®æœªå‘½ä¸­è¦ç‚¹</text>
    </view>
    
    <!-- è¿½é—®æç¤º -->
    <view class="follow-up-hint" wx:if="followUpEnabled">
      <text class="hint-text">ğŸ’¡ AIå°†å¯¹æ‚¨çš„å›ç­”è¿›è¡Œè¿›ä¸€æ­¥è¿½é—®ï¼Œè¯·åšå¥½å‡†å¤‡</text>
    </view>
    
    <!-- åŸå¸‚è–ªèµ„åŒ¹é…ç»“æœ -->
    <view class="salary-match-card {{animationState.salaryCard !== 'idle' ? 'animate-in' : ''}}" wx:if="salaryMatchResult && salaryMatchResult.industryAverage">
      <view class="salary-title">
        <image src="/images/settings.png" class="salary-icon"></image>
        åŸå¸‚è–ªèµ„åŒ¹é…
      </view>
      <view class="salary-content">
        <view class="salary-item">
          <view class="salary-label">è¡Œä¸šå¹³å‡</view>
          <view class="salary-value">{{salaryMatchResult.industryAverage}}</view>
        </view>
        <view class="salary-item">
          <view class="salary-label">æ‚¨çš„é¢„æœŸ</view>
          <view class="salary-value salary-expected">{{salaryMatchResult.expectedSalary}}</view>
        </view>
        <view class="salary-item">
          <view class="salary-label">åŒ¹é…åº¦</view>
          <view class="salary-value salary-match">
            {{salaryMatchResult.matchPercentage}}% <text class="match-status">{{salaryMatchResult.matchStatus}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¼šè¯æ—¶é—´çº¿ - SessionTimeline -->
  <view class="timeline-section">
    <view class="timeline-title">é¢è¯•è¿›åº¦</view>
    <view class="timeline-container">
      <view wx:for="{{sessionTimeline}}" wx:key="index" class="timeline-item">
        <view class="timeline-dot timeline-{{item.status}}">
          <view class="timeline-number">{{index + 1}}</view>
        </view>
        <view class="timeline-line" wx:if="index < sessionTimeline.length - 1"></view>
      </view>
    </view>
    <view class="timeline-stats">
      <text>å·²å®Œæˆï¼š{{completedQuestions}}/{{maxRounds}}</text>
      <text>å½“å‰é—®é¢˜ï¼š{{currentRound}}/{{maxRounds}}</text>
    </view>
  </view>

  <!-- åº•éƒ¨æŒ‰é’® - NextSkipButtons -->
  <view class="action-buttons">
    <button 
      class="voice-btn" 
      bindtap="toggleRecording" 
      disabled="{{loading}}">
      <image src="/images/settings.png"></image>
      {{recording ? 'åœæ­¢å½•éŸ³' : 'è¯­éŸ³è¾“å…¥'}}
    </button>
    <button 
      class="btn btn-secondary skip-btn" 
      bindtap="skipQuestion"
      disabled="{{loading || !userAnswer}}">
      <image src="/images/settings.png" class="btn-icon-small"></image>
      è·³è¿‡å½“å‰ç‚¹
    </button>
    <button 
      class="btn btn-warning mark-btn" 
      bindtap="markAsDifficult"
      disabled="{{loading || !userAnswer}}">
      <image src="/images/settings.png" class="btn-icon-small"></image>
      æ ‡è®°éš¾ç‚¹
    </button>
    <button 
      class="submit-btn" 
      bindtap="submitAnswer"
      disabled="{{loading || !userAnswer.trim()}}">
      {{showFeedback ? 'ä¸‹ä¸€é¢˜' : 'æäº¤å›ç­”'}}
    </button>
  </view>

  <!-- åŠ è½½æç¤º -->
  <view class="loading-mask" wx:if="loading">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{loadingText}}</text>
    </view>
  </view>
</view>